# eTracee - åŸºäºeBPFçš„ç³»ç»Ÿè°ƒç”¨ç›‘æ§ç³»ç»Ÿ

> è½»é‡çº§eBPFç³»ç»Ÿè°ƒç”¨ç›‘æ§å·¥å…·ï¼Œå®æ—¶æ•è·å’Œåˆ†æç³»ç»Ÿè¡Œä¸º

## ğŸ¯ é¡¹ç›®ç®€ä»‹

**eTracee** æ˜¯ä¸€ä¸ªåŸºäºeBPFæŠ€æœ¯çš„ç³»ç»Ÿè°ƒç”¨ç›‘æ§å·¥å…·ï¼Œä¸“æ³¨äºå®æ—¶æ•è·å’Œåˆ†æLinuxç³»ç»Ÿçš„å…³é”®ç³»ç»Ÿè°ƒç”¨ã€‚é¡¹ç›®é‡‡ç”¨ç°ä»£åŒ–çš„eBPF CO-RE (Compile Once, Run Everywhere) æŠ€æœ¯ï¼Œæä¾›é«˜æ€§èƒ½ã€ä½å¼€é”€çš„å†…æ ¸çº§ç›‘æ§èƒ½åŠ›ã€‚

### æ ¸å¿ƒç‰¹æ€§

- ğŸ” **å†…æ ¸çº§ç›‘æ§**: åŸºäºeBPFæŠ€æœ¯ï¼Œæ— ä¾µå…¥å¼æ•è·ç³»ç»Ÿè°ƒç”¨
- âš¡ **é«˜æ€§èƒ½ä¼ è¾“**: ä½¿ç”¨Ring Bufferå®ç°é«˜æ•ˆçš„å†…æ ¸-ç”¨æˆ·æ€æ•°æ®ä¼ è¾“
- ğŸ¯ **ç²¾å‡†ç›‘æ§**: ä¸“æ³¨ç›‘æ§execveã€openatã€connectç­‰å…³é”®ç³»ç»Ÿè°ƒç”¨
- ğŸ“Š **ç»“æ„åŒ–è¾“å‡º**: æ ‡å‡†JSONæ ¼å¼è¾“å‡ºï¼Œä¾¿äºåç»­å¤„ç†å’Œåˆ†æ
- ğŸš€ **CO-REå…¼å®¹**: ä¸€æ¬¡ç¼–è¯‘ï¼Œå¤šå†…æ ¸ç‰ˆæœ¬è¿è¡Œ
- ğŸ›¡ï¸ **è½»é‡è®¾è®¡**: æœ€å°åŒ–ç³»ç»Ÿèµ„æºå ç”¨å’Œæ€§èƒ½å½±å“

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Linux Kernel Space                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  eBPF Program (probe.c)                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ execve tracepointâ”‚  â”‚openat tracepointâ”‚  â”‚connect traceâ”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚   point     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚                                â”‚
â”‚                           â–¼                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Ring Buffer (256KB)                       â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼ (é«˜æ•ˆæ•°æ®ä¼ è¾“)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    User Space                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Go Program (ebpf_receiver)                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚  Event Parser   â”‚  â”‚ Timestamp Fix   â”‚  â”‚JSON Output  â”‚ â”‚
â”‚  â”‚                 â”‚  â”‚                 â”‚  â”‚             â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                           â”‚                                â”‚
â”‚                           â–¼                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚         Structured JSON Event Stream                   â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### ç³»ç»Ÿè¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: Linux (å†…æ ¸ç‰ˆæœ¬ >= 4.18ï¼Œæ”¯æŒeBPF CO-RE)
- **ç¼–è¯‘ç¯å¢ƒ**: clang, llvm, libbpf-dev
- **è¿è¡Œæƒé™**: rootæƒé™æˆ–CAP_BPFèƒ½åŠ›
- **Goç‰ˆæœ¬**: >= 1.19
- **å†…å­˜**: >= 1GB RAM
- **å­˜å‚¨**: >= 500MB å¯ç”¨ç©ºé—´

### ç¯å¢ƒå‡†å¤‡

#### Ubuntu/Debianç³»ç»Ÿ
```bash
sudo apt-get update
sudo apt-get install -y clang llvm libbpf-dev bpftool
```

#### CentOS/RHEL/openEulerç³»ç»Ÿ
```bash
sudo yum install -y clang llvm libbpf-devel bpftool
```

### ç¼–è¯‘å®‰è£…

```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/2577552541/eTracee.git
cd eTracee

# ä¸€é”®æ„å»º
make

# æˆ–åˆ†æ­¥æ„å»º
make ebpf      # ç¼–è¯‘eBPFç¨‹åº
make go-build  # æ„å»ºGoç¨‹åº
```

### è¿è¡Œç›‘æ§

```bash
# å¯åŠ¨ç³»ç»Ÿè°ƒç”¨ç›‘æ§ (éœ€è¦rootæƒé™)
sudo ./bin/ebpf_receiver
```

### éªŒè¯å®‰è£…

```bash
# æ£€æŸ¥æ„å»ºçŠ¶æ€
make status

# è¿è¡ŒåŸºç¡€æµ‹è¯•
make test
```

## ğŸ“ é¡¹ç›®ç»“æ„

```
eTracee/
â”œâ”€â”€ Makefile                    # é¡¹ç›®ä¸»æ„å»ºæ–‡ä»¶
â”œâ”€â”€ README.md                   # é¡¹ç›®æ–‡æ¡£
â”œâ”€â”€ bin/                        # ç¼–è¯‘è¾“å‡ºç›®å½•
â”‚   â””â”€â”€ ebpf_receiver          # Goç”¨æˆ·æ€ç¨‹åº
â”œâ”€â”€ bpf/                        # eBPFå†…æ ¸ç¨‹åº
â”‚   â”œâ”€â”€ Makefile               # eBPFæ„å»ºæ–‡ä»¶
â”‚   â””â”€â”€ probe.c                # eBPFç›‘æ§ç¨‹åº
â”œâ”€â”€ cmd/                        # Goç¨‹åºæºç 
â”‚   â””â”€â”€ ebpf_receiver/         # ç”¨æˆ·æ€äº‹ä»¶æ¥æ”¶å™¨
â”‚       â”œâ”€â”€ go.mod             # Goæ¨¡å—ä¾èµ–
â”‚       â”œâ”€â”€ go.sum             # ä¾èµ–æ ¡éªŒæ–‡ä»¶
â”‚       â””â”€â”€ main.go            # ä¸»ç¨‹åºæ–‡ä»¶
â”œâ”€â”€ docs/                       # æŠ€æœ¯æ–‡æ¡£
â”‚   â””â”€â”€ week1-2-implementation.md
â”œâ”€â”€ test/                       # æµ‹è¯•è„šæœ¬
â”‚   â”œâ”€â”€ execve_trace.bt        # bpftraceæµ‹è¯•è„šæœ¬
â”‚   â”œâ”€â”€ ingest_realtime.py     # Pythonæ•°æ®é‡‡é›†å™¨
â”‚   â”œâ”€â”€ test_result.log        # æµ‹è¯•ç»“æœæ—¥å¿—
â”‚   â””â”€â”€ trigger_exec.sh        # æµ‹è¯•äº‹ä»¶è§¦å‘å™¨
â””â”€â”€ setup-ebpf.sh              # ç¯å¢ƒå®‰è£…è„šæœ¬
```

## ğŸ”§ æŠ€æœ¯å®ç°

### eBPFç¨‹åºç‰¹æ€§

**ç›‘æ§çš„ç³»ç»Ÿè°ƒç”¨:**
- `execve`: è¿›ç¨‹æ‰§è¡Œç›‘æ§ï¼Œæ•è·æ–°è¿›ç¨‹å¯åŠ¨
- `openat`: æ–‡ä»¶è®¿é—®ç›‘æ§ï¼Œè·Ÿè¸ªæ–‡ä»¶æ“ä½œ
- `connect`: ç½‘ç»œè¿æ¥ç›‘æ§ï¼Œæ£€æµ‹ç½‘ç»œæ´»åŠ¨

**äº‹ä»¶æ•°æ®ç»“æ„:**
```c
struct event {
    u64 timestamp;      // æ—¶é—´æˆ³ (çº³ç§’)
    u32 pid;           // è¿›ç¨‹ID
    u32 ppid;          // çˆ¶è¿›ç¨‹ID
    u32 uid;           // ç”¨æˆ·ID
    u32 gid;           // ç»„ID
    u32 event_type;    // äº‹ä»¶ç±»å‹ (1=execve, 2=openat, 3=connect)
    char comm[16];     // è¿›ç¨‹å
    char filename[256]; // æ–‡ä»¶å/è·¯å¾„
    u32 syscall_nr;    // ç³»ç»Ÿè°ƒç”¨å·
    s32 ret_code;      // è¿”å›ç 
};
```

### JSONè¾“å‡ºæ ¼å¼

```json
{
  "timestamp": 1640995200123456789,
  "time_str": "2022-01-01 12:00:00.123456",
  "pid": 1234,
  "ppid": 1000,
  "uid": 1000,
  "gid": 1000,
  "event_type": 1,
  "event_name": "execve",
  "comm": "bash",
  "filename": "/bin/ls",
  "syscall_nr": 59,
  "ret_code": 0
}
```

### å…³é”®æŠ€æœ¯ç‰¹ç‚¹

1. **CO-REæŠ€æœ¯**: ä½¿ç”¨BTFå®ç°å†…æ ¸ç‰ˆæœ¬å…¼å®¹æ€§
2. **Ring Buffer**: é«˜æ•ˆçš„å†…æ ¸-ç”¨æˆ·æ€æ•°æ®ä¼ è¾“
3. **æ—¶é—´æˆ³å¤„ç†**: å‡†ç¡®è½¬æ¢eBPFæ—¶é—´æˆ³ä¸ºå®é™…æ—¶é—´
4. **å†…å­˜å¯¹é½**: ç²¾ç¡®åŒ¹é…å†…æ ¸å’Œç”¨æˆ·æ€æ•°æ®ç»“æ„
5. **ä¼˜é›…é€€å‡º**: å®Œå–„çš„ä¿¡å·å¤„ç†å’Œèµ„æºæ¸…ç†

## ğŸ› ï¸ ä½¿ç”¨æŒ‡å—

### åŸºç¡€ç›‘æ§

```bash
# å¯åŠ¨å®æ—¶ç›‘æ§
sudo ./bin/ebpf_receiver

# è¾“å‡ºé‡å®šå‘åˆ°æ–‡ä»¶
sudo ./bin/ebpf_receiver > events.json

# ç»“åˆjqè¿›è¡Œå®æ—¶åˆ†æ
sudo ./bin/ebpf_receiver | jq '.event_name'
```

### è¿‡æ»¤ç‰¹å®šäº‹ä»¶

```bash
# åªç›‘æ§execveäº‹ä»¶
sudo ./bin/ebpf_receiver | jq 'select(.event_name == "execve")'

# ç›‘æ§ç‰¹å®šç”¨æˆ·çš„æ´»åŠ¨
sudo ./bin/ebpf_receiver | jq 'select(.uid == 1000)'

# ç›‘æ§æ–‡ä»¶è®¿é—®
sudo ./bin/ebpf_receiver | jq 'select(.event_name == "openat")'
```

### å¼€å‘å’Œè°ƒè¯•

```bash
# æŸ¥çœ‹é¡¹ç›®çŠ¶æ€
make status

# æ¸…ç†é‡æ–°æ„å»º
make clean && make

# å¼€å‘æ¨¡å¼è¿è¡Œ
make dev
```

## ğŸ” ç›‘æ§èƒ½åŠ›

å½“å‰å®ç°å¯ä»¥æ£€æµ‹ä»¥ä¸‹ç³»ç»Ÿè¡Œä¸ºï¼š

### è¿›ç¨‹æ´»åŠ¨ç›‘æ§
- æ–°è¿›ç¨‹å¯åŠ¨ (execve)
- è¿›ç¨‹æ‰§è¡Œé“¾è·Ÿè¸ª
- çˆ¶å­è¿›ç¨‹å…³ç³»åˆ†æ

### æ–‡ä»¶ç³»ç»Ÿç›‘æ§
- æ–‡ä»¶æ‰“å¼€æ“ä½œ (openat)
- æ•æ„Ÿæ–‡ä»¶è®¿é—®æ£€æµ‹
- æ–‡ä»¶è®¿é—®æ¨¡å¼åˆ†æ

### ç½‘ç»œæ´»åŠ¨ç›‘æ§
- ç½‘ç»œè¿æ¥å»ºç«‹ (connect)
- å¼‚å¸¸ç½‘ç»œè¡Œä¸ºæ£€æµ‹
- è¿›ç¨‹ç½‘ç»œæ´»åŠ¨å…³è”

## ğŸš§ å¼€å‘è·¯çº¿å›¾

### å·²å®ŒæˆåŠŸèƒ½ âœ…
- [x] eBPFå†…æ ¸ç¨‹åºå®ç°
- [x] Ring Bufferæ•°æ®ä¼ è¾“
- [x] Goç”¨æˆ·æ€äº‹ä»¶å¤„ç†
- [x] JSONæ ‡å‡†åŒ–è¾“å‡º
- [x] æ—¶é—´æˆ³å‡†ç¡®è½¬æ¢
- [x] å®Œæ•´æ„å»ºç³»ç»Ÿ

### è®¡åˆ’åŠŸèƒ½ ğŸ”„
- [ ] äº‹ä»¶è¿‡æ»¤å’Œèšåˆ
- [ ] è½»é‡çº§è§„åˆ™å¼•æ“
- [ ] æ•°æ®å­˜å‚¨åç«¯
- [ ] Webå¯è§†åŒ–ç•Œé¢
- [ ] æ”»å‡»é“¾åˆ†æ
- [ ] å¼‚å¸¸æ£€æµ‹ç®—æ³•

## ğŸ¤ è´¡çŒ®æŒ‡å—

æ¬¢è¿è´¡çŒ®ä»£ç å’Œå»ºè®®ï¼è¯·éµå¾ªä»¥ä¸‹æ­¥éª¤ï¼š

1. Fork æœ¬é¡¹ç›®
2. åˆ›å»ºç‰¹æ€§åˆ†æ”¯ (`git checkout -b feature/AmazingFeature`)
3. æäº¤æ›´æ”¹ (`git commit -m 'Add some AmazingFeature'`)
4. æ¨é€åˆ°åˆ†æ”¯ (`git push origin feature/AmazingFeature`)
5. å¼€å¯ Pull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ - è¯¦è§ [LICENSE](LICENSE) æ–‡ä»¶

## ğŸ™ è‡´è°¢

- [eBPF ç¤¾åŒº](https://ebpf.io/) - æä¾›å¼ºå¤§çš„å†…æ ¸ç¼–ç¨‹æ¡†æ¶
- [cilium/ebpf](https://github.com/cilium/ebpf) - ä¼˜ç§€çš„Go eBPFåº“
- [libbpf](https://github.com/libbpf/libbpf) - eBPFç”¨æˆ·æ€åº“

## ğŸ“ è”ç³»æ–¹å¼

- é¡¹ç›®ä¸»é¡µ: https://github.com/2577552541/eTracee
- é—®é¢˜åé¦ˆ: https://github.com/2577552541/eTracee/issues

---

**eTracee** - è®©ç³»ç»Ÿè¡Œä¸ºä¸€ç›®äº†ç„¶ ğŸ”